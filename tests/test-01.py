import unittest

from sd_webui_pnginfo_injection.on_before_image_saved import add_resource_hashes
from sd_webui_pnginfo_injection.utils import try_parse_load


class MyTestCase(unittest.TestCase):
    def test_something(self):
        res = {}
        val = try_parse_load(res, "Hashes", default_val={})
        self.assertEqual(val, {})  # add assertion here

        val = try_parse_load(res, "Hashes")
        self.assertEqual(val, None)  # add assertion here
    def test_something2(self):
        res = {
            "Hashes": '{"vae": "df3c506e51", "embed:Tower13_Gizelle": "9ece223c52", "embed:EasyNegative": "c74b4e810b", "model": "0a880e98ab"}'
        }
        val = try_parse_load(res, "Hashes")
        self.assertEqual(val, {"vae": "df3c506e51", "embed:Tower13_Gizelle": "9ece223c52", "embed:EasyNegative": "c74b4e810b", "model": "0a880e98ab"})

    def test_something3(self):
        obj = lambda: None
        obj.pnginfo = lambda: None
        obj.pnginfo.parameters = 'Steps: 20, Sampler: DPM++ 2M, Schedule type: Karras, CFG scale: 7, Seed: 557152044, Size: 768x512, Model hash: 0a880e98ab, Model: meinacetusorionmix_v10, VAE hash: df3c506e51, VAE: kl-f8-anime2.ckpt, Hypertile U-Net: True, Hypertile VAE: True, ADetailer model: hand_yolov8n.pt, ADetailer prompt: "highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), (perfect face, beautiful face, perfect lips, perfect mouth, perfect detailed leg, beautiful detailed leg, perfect accurate limb, perfect beautiful breasts, perfect body, perfect anatomy), (perfect hands, perfect hand anatomy, perfect finger, beautiful finger, perfect hands, good hands:1.2), beautiful and aesthetic, highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic),  \\n(1girl, solo:1.6), \\nTower13_Gizelle, \\na beautiful elvish girl, \\n \\n(tan hair,cyan hair ,rainbow hair,Iridescence hair,streaked hair), \\n \\nBREAK\\n(pure blue background,transparent background), \\nBREAK\\n \\ntraditional_korean_interior,Traditional Korean interior,ondol_heated_floors,paper_doors,low_tables,traditional_korean_houses,natural_light_diffusion,sliding_doors,east asian architecture,interior,indoors", ADetailer confidence: 0.3, ADetailer dilate erode: 4, ADetailer mask blur: 4, ADetailer denoising strength: 0.45, ADetailer inpaint only masked: True, ADetailer inpaint padding: 32, ADetailer ControlNet model: Passthrough, ADetailer model 2nd: face_yolov8n_v2.pt, ADetailer prompt 2nd: "highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), (perfect face, beautiful face, perfect lips, perfect mouth, perfect detailed leg, beautiful detailed leg, perfect accurate limb, perfect beautiful breasts, perfect body, perfect anatomy), (perfect hands, perfect hand anatomy, perfect finger, beautiful finger, perfect hands, good hands:1.2), beautiful and aesthetic, highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic),  \\n(1girl, solo:1.6), \\nTower13_Gizelle, \\na beautiful elvish girl, \\n \\n(tan hair,cyan hair ,rainbow hair,Iridescence hair,streaked hair), \\n \\nBREAK\\n(pure blue background,transparent background), \\nBREAK\\n \\ntraditional_korean_interior,Traditional Korean interior,ondol_heated_floors,paper_doors,low_tables,traditional_korean_houses,natural_light_diffusion,sliding_doors,east asian architecture,interior,indoors", ADetailer negative prompt 2nd: "(African American, African:1.6), EasyNegative, (normal quality, low quality, worst quality:1.4), jpeg artifacts, (username, watermark, signature, time signature, timestamp, artist name, artist signature, artist logo, twitter username, patreon username, copyright name, copyright notice, copyright abbreviation, copyright signature, copyright), (loli, child, infant, baby:1.3), (bad anatomy, extra digits, extra_fingers, wrong finger, inaccurate limb, bad hand, bad fingers), (African American, African:1.6), (tits, nipple, nipples:1.6), (pubic hair:1.6), multiple views, multiple frame", ADetailer confidence 2nd: 0.3, ADetailer dilate erode 2nd: 4, ADetailer mask blur 2nd: 4, ADetailer denoising strength 2nd: 0.4, ADetailer inpaint only masked 2nd: True, ADetailer inpaint padding 2nd: 32, ADetailer ControlNet model 2nd: Passthrough, ADetailer version: 24.6.0, sv_prompt: "highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), #, __lazy-wildcards/utils/interior-style-anything__, \\n#, \\n(1girl, solo:1.6), \\nTower13_Gizelle, \\na beautiful elvish girl, \\n#, $(char-skin-tanned-dark-black-bronze-001), \\n(__lazy-wildcards/char/haircolor__), \\n#, __lazy-wildcards/prompts/pose__, \\nBREAK\\n(__lazy-wildcards/dataset/background-color__), \\nBREAK\\n#, __lazy-wildcards/dataset/background__, \\n__lazy-wildcards/subject/interior/traditional-cjk/prompts__", sv_negative: "EasyNegative, (normal quality, low quality, worst quality:1.4), jpeg artifacts, (username, watermark, signature, time signature, timestamp, artist name, artist signature, artist logo, twitter username, patreon username, copyright name, copyright notice, copyright abbreviation, copyright signature, copyright), (loli, child, infant, baby:1.3), (bad anatomy, extra digits, extra_fingers, wrong finger, inaccurate limb, bad hand, bad fingers), (African American, African:1.6), (tits, nipple, nipples:1.6), (pubic hair:1.6), multiple views, multiple frame", Dynamic Prompts: {"use_fixed_seed": false, "unlink_seed_from_prompt": true, "enable_jinja_templates": false}, Template: "highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), #, __lazy-wildcards/utils/interior-style-anything__, \\n#, \\n(1girl, solo:1.6), \\nTower13_Gizelle, \\na beautiful elvish girl, \\n#, dark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(__lazy-wildcards/char/haircolor__), \\n#, __lazy-wildcards/prompts/pose__, \\nBREAK\\n(__lazy-wildcards/dataset/background-color__), \\nBREAK\\n#, __lazy-wildcards/dataset/background__, \\n__lazy-wildcards/subject/interior/traditional-cjk/prompts__", Template Generated: "highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic),  \\n(1girl, solo:1.6), \\nTower13_Gizelle, \\na beautiful elvish girl, \\n \\n(tan hair,cyan hair ,rainbow hair,Iridescence hair,streaked hair), \\n \\nBREAK\\n(pure blue background,transparent background), \\nBREAK\\n \\ntraditional_korean_interior,Traditional Korean interior,ondol_heated_floors,paper_doors,low_tables,traditional_korean_houses,natural_light_diffusion,sliding_doors,east asian architecture,interior,indoors", Template Seeds: 557152044, Template Seeds Sub: 1298678300, TI hashes: "Tower13_Gizelle: 9ece223c52f8, EasyNegative: c74b4e810b03", Hardware Info: "RTX 3060 Ti 8GB, i7-13700, 32GB RAM", Time taken: 22.5 sec., Version: v1.9.4-191-g6ca0466e, Hashes: {"vae": "df3c506e51", "embed:Tower13_Gizelle": "9ece223c52", "embed:EasyNegative": "c74b4e810b", "model": "0a880e98ab"}'

        val = add_resource_hashes(obj)
        self.assertEqual(val, {"vae": "df3c506e51", "embed:Tower13_Gizelle": "9ece223c52", "embed:EasyNegative": "c74b4e810b", "model": "0a880e98ab"})


if __name__ == '__main__':
    unittest.main()
