import json
import unittest

from sd_webui_pnginfo_injection.on_before_image_saved import _add_resource_hashes_core_params, \
    _add_resource_hashes_core_dict
from sd_webui_pnginfo_injection.pnginfo import parse_generation_parameters

lastline = '''
Steps: 20, Sampler: DPM++ 2M Karras, CFG scale: 7, Seed: 557152044, Size: 512x768, Model hash: 5307b134ff, Model: geminixMixRealistic_bV10, VAE hash: df3c506e51, VAE: kl-f8-anime2.ckpt, ADetailer model: PitHandDetailer-v1-seg.pt, ADetailer prompt: "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), (perfect face, beautiful face, perfect lips, perfect mouth, perfect detailed leg, beautiful detailed leg, perfect accurate limb, perfect beautiful *****, perfect body, perfect anatomy), (perfect hands, perfect hand anatomy, perfect finger, beautiful finger, perfect hands, good hands:1.2), beautiful and aesthetic, (otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:1>, \\nCar Parking,road,concrete,parking, \\npure blue background,transparent background, \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(salt and pepper hair,red brown hair,), (fantasy world), (fantasy world)", ADetailer confidence: 0.3, ADetailer dilate erode: 4, ADetailer mask blur: 4, ADetailer denoising strength: 0.4, ADetailer inpaint only masked: True, ADetailer inpaint padding: 32, ADetailer ControlNet model: Passthrough, ADetailer model 2nd: face_yolov8n_v2.pt, ADetailer prompt 2nd: "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), (perfect face, beautiful face, perfect lips, perfect mouth, perfect detailed leg, beautiful detailed leg, perfect accurate limb, perfect beautiful *****, perfect body, perfect anatomy), (perfect hands, perfect hand anatomy, perfect finger, beautiful finger, perfect hands, good hands:1.2), beautiful and aesthetic, (otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:1>, \\nCar Parking,road,concrete,parking, \\npure blue background,transparent background, \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(salt and pepper hair,red brown hair,), (fantasy world), (fantasy world)", ADetailer negative prompt 2nd: "(African American, African:1.6), EasyNegative, (normal quality, low quality, worst quality:1.4), jpeg artifacts, (username, watermark, signature, time signature, timestamp, artist name, artist signature, artist logo, twitter username, patreon username, copyright name, copyright notice, copyright abbreviation, copyright signature, copyright), (loli, child, infant, baby:1.3), (bad anatomy, extra digits, extra_fingers, wrong finger, inaccurate limb, bad hand, bad fingers), (African American, African:1.6), (*****, nipple, nipples:1.6), (pubic hair:1.6), multiple views, multiple frame", ADetailer confidence 2nd: 0.3, ADetailer dilate erode 2nd: 4, ADetailer mask blur 2nd: 4, ADetailer denoising strength 2nd: 0.4, ADetailer inpaint only masked 2nd: True, ADetailer inpaint padding 2nd: 32, ADetailer ControlNet model 2nd: Passthrough, ADetailer version: 24.5.1, sv_prompt: "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:1>, \\n__lazy-wildcards/subject/architectural/parking/prompts__, \\n__lazy-wildcards/dataset/background-color__, \\n#, __cf-waitress/prompt-full__, \\n$char-skin-tanned-dark-黑皮-bronze-001, \\n(__lazy-wildcards/char/haircolor__), (fantasy world)", sv_negative: "EasyNegative, (normal quality, low quality, worst quality:1.4), jpeg artifacts, (username, watermark, signature, time signature, timestamp, artist name, artist signature, artist logo, twitter username, patreon username, copyright name, copyright notice, copyright abbreviation, copyright signature, copyright), (loli, child, infant, baby:1.3), (bad anatomy, extra digits, extra_fingers, wrong finger, inaccurate limb, bad hand, bad fingers), (African American, African:1.6), (*****, nipple, nipples:1.6), (pubic hair:1.6), multiple views, multiple frame", Dynamic Prompts: {"use_fixed_seed": false, "unlink_seed_from_prompt": true, "enable_jinja_templates": false}, Template: "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:1>, \\n__lazy-wildcards/subject/architectural/parking/prompts__, \\n__lazy-wildcards/dataset/background-color__, \\n#, __cf-waitress/prompt-full__, \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(__lazy-wildcards/char/haircolor__), (fantasy world)", Cutoff enabled: True, Cutoff targets: ["white", "black", "green", "red", "blue", "yellow", "pink", "purple", "bronze", "*****", "silver", "magenta"], Cutoff padding: _</w>, Cutoff weight: 0.5, Cutoff disable_for_neg: True, Cutoff strong: False, Cutoff interpolation: lerp, Lora hashes: "UnderGround-CP: 840de6c452f6", Template Generated: "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n, \\nCar Parking,road,concrete,parking, \\npure blue background,transparent background, \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(salt and pepper hair,red brown hair,), (fantasy world)", Template Seeds: [557152046], Template Seeds Sub: [2223099060], TI hashes: "Tower13_Gizelle: 9ece223c52f8, Tower13_Gizelle: 9ece223c52f8, Tower13_Gizelle: 9ece223c52f8, Tower13_Gizelle: 9ece223c52f8, Tower13_Gizelle: 9ece223c52f8, Tower13_Gizelle: 9ece223c52f8, EasyNegative: c74b4e810b03", Hardware Info: "RTX 3060 Ti 8GB, 13th Gen i7-13700, 32GB RAM", Time taken: 26.5 sec., Version: f0.0.17v1.8.0rc-1.7.0,Template Generated Grid: ["(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:0>, \\nCar Parking,road,concrete,parking, \\npure black background,pure red background,pure cyan background , \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(neon orange hair,maroon hair,), (fantasy world)", "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:0>, \\nCar Parking,road,concrete,parking, \\nsalt and pepper background, \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(copper hair,colored inner hair), (fantasy world)", "(otherworldly), highly insanely detailed, masterpiece, top quality, best quality, highres, 4k, 8k, RAW photo, (very aesthetic, beautiful and aesthetic), 1girl, solo, \\nTower13_Gizelle, \\na beautiful elvish girl, \\n<lora:UnderGround-CP:0>, \\nCar Parking,road,concrete,parking, \\nturquoise background, \\n \\ndark_skin, tan_skin, tanned skin, dark skin, dark-skinned, black-skinned, bronze skin, \\n(emerald green hair,sparkling silver hair,silver hair,rainbow hair,Iridescence hair,multi_color_hair,multicolored hair,multi colored hair), (fantasy world)"]
'''

class MyTestCase(unittest.TestCase):
    def test_something(self):
        res = parse_generation_parameters(lastline, True)

        print(json.dumps(res, indent=2))

        self.assertIsInstance(res["Cutoff targets"], list)
        self.assertIsInstance(res["Dynamic Prompts"], dict)

        self.assertIsInstance(res["Template Generated Grid"], list)
        self.assertIsInstance(res["Template Generated Grid"][0], str)
        self.assertIn("\n", res["Template Generated Grid"][0])

        resource_hashes, hashes_is_changed = _add_resource_hashes_core_dict(res)

        print(json.dumps(resource_hashes, indent=2))

        self.assertIn("lora:UnderGround-CP", resource_hashes)

        # self.assertEqual(True, False)  # add assertion here

if __name__ == '__main__':
    unittest.main()
